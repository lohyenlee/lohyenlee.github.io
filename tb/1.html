<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    html,body { 
      /* overflow-x: hidden;  */
      /* overflow-y: scroll;  */
      background-color:#999; padding:0; margin:0; width:100%; height:100%; font-family:sans-serif; font-size: 24px;
    }
  </style>
</head>
<body id="body" style="height: calc(100lvh + 64px);">


  <div id="logdiv" style="position:absolute; left:30%; bottom:50%;">
  </div> 

  <!-- <div id="scroller" style="width: 16px; height: 16px; background-color: #f00;"></div>
  </div> -->

  <canvas id="canvas"
  style="position:absolute;top:0;left:0;"></canvas>

  <div id="controls" style="position:fixed; bottom:0; left:0; width:100%;">
    <div style="position: absolute; left:0;bottom:0;" id="joyContainer">
      <div style="
      z-index:2; position:absolute; left:0; bottom:0; width:140px; height:140px; 
      background-image:url('joystick.webp'); background-position:center; background-size:140px; background-repeat: no-repeat;">
      </div>
      <div id="joystick" style="
      display:none;
      z-index:3; position:absolute; left:0; bottom:0; width:140px; height:140px; 
      background-image:url('joystick.webp'); background-position:center; background-size:100px; background-repeat: no-repeat;
      color:white; text-align:center; vertical-align:middle;
      transform:translate(0,0);">
      </div>
    </div>
  </div>


  <script type="module">
    //=======================================================
    // UTILITIES
    //=======================================================
    const clamp=(x,a,b) => Math.min(Math.max(x,a),b)
    
    //=================================================
    // GRAPHICS (VARIABLES AND FUNCTIONS)
    //=================================================
    const ctx=canvas.getContext('2d')
    let winWid,winHei
    let timeOfLastFrame=0
    let timeStepInMilliseconds = 1000/60.  //300.
    
    function log(s) {
      logdiv.innerText += s
    }

    function setScaling() {
      winWid=visualViewport.width||window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth
      winHei=visualViewport.height||window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight
      canvas.width = winWid
      canvas.height = winHei
      // scroller.style.height = (winHei + 64) + "px"
      //body.style.height = (winHei + 64) + "px"
      console.log('asdf')

      body.scrollBy(0,64)
      // canvas.style.left = Math.floor((winWid-canvas.width)/2) + "px"
      
      // const viewportHeight = window.visualViewport.innerHeight;
      // document.documentElement.style.setProperty('--vh', `${viewportHeight}px`);
    }
    function render() {
      //======== DRAW BACKGROUND AND GAME AREA
      ctx.clearRect(0, 0, canvas.width, canvas.height)
      ctx.fillStyle='#000'
      ctx.strokeStyle='#0F0'
      ctx.moveTo(0,0)
      ctx.lineTo(canvas.width, canvas.height)
      ctx.stroke()

    }
    
    function animate(timeCurrent) {
      requestAnimationFrame(animate)
      render() 
  
      const elapsed = Date.now() - timeOfLastFrame
      if (elapsed <= timeStepInMilliseconds) return
      timeOfLastFrame = Date.now()
      
      
      logdiv.innerText='\n\n\n'
      log(`body: ${document.body.clientWidth} x ${document.body.clientHeight}\n`)
      log(`window: ${window.innerWidth} x ${window.innerHeight}\n`)
      log(`vvport: ${visualViewport.width} x ${window.visualViewport.height}\n`)
      log(`canvas: ${canvas.width} x ${canvas.height}\n`)
      // log(`scroller: ${scroller.style.width} x ${scroller.style.height}\n`)
      
      
    }

    //=================================================
    // INTERACTIVITY
    //=================================================
    let joyAnchorX,joyAnchorY,joyX=0,joyY=0;
    function joyTouchStart(e) {
      e.preventDefault()
      joyAnchorX=event.touches[0].pageX
      joyAnchorY=event.touches[0].pageY
    }
    function joyTouchMove(e) {
      e.preventDefault()
      joyX=clamp(event.touches[0].pageX-joyAnchorX,-40,40)
      joyY=clamp(event.touches[0].pageY-joyAnchorY,-40,40)
      joystick.style.transform=`translate(${joyX}px,${joyY}px)`
    }
    function joyTouchEnd(e) {
      joyX=0; joyY=0
      joystick.style.transform='translate(0,0)'
    }

    function onscroll(e) {
      joyContainer.style.left = (Math.random()*100) + 'px'

    }

    //===============================================
    // MAIN MODULE CODE
    //===============================================    
    setScaling()

    window.addEventListener('resize', setScaling)
    window.visualViewport.addEventListener('resize', setScaling)

    document.body.addEventListener('dblclick', e=>e.preventDefault())
    joystick.addEventListener('touchstart', joyTouchStart)
    joystick.addEventListener('touchmove',  joyTouchMove)
    joystick.addEventListener('touchend',  joyTouchEnd)

    document.addEventListener("scroll", onscroll)

    joystick.style.display = 'block' // Show
    canvas.style.display = 'block' // Show
    controls.style.display = 'block'
    requestAnimationFrame(animate)
    

  </script>
</body>
</html> 