<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    @font-face {
      font-family: 'gameFont';
      src: url('Retro Gaming.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    :root {--btnsize:8vmin;}
    html,body { 
      overflow: hidden;  /* prevent scrollbars */
      background-color:#333; padding:0; margin:0; width:100%; height:100%; font-family:'gameFont',sans-serif;
    }
    @keyframes Animation { 
      0%{background-position:10% 0%}
      50%{background-position:91% 100%}
      100%{background-position:10% 0%}
    }
    #splashScreen {
      width: 100%; height:100%; text-align: center; color:white;
      border:1px solid black;
      background: linear-gradient(130deg, #262626, #ff7e00, #fff200);
      background-size: 200% 200%;
      animation: Animation 4s ease infinite;
    }
    #canvas {position:absolute; z-index:1;}
    #helpDivContainer {
      margin: 32px;
      padddng: 32px;
    }
    #helpDiv {
      display: none;
      z-index:4;position:absolute;  right: 0; bottom:0; height:fit-content; width:80%; 
      padding: 1rem 2rem 1rem 6rem; 
      box-shadow: 0px 4 px 8px 0px #333, 0px 8px 16px 8px #000; background-color:#666; border:double 4px black; border-radius: 20px; 
      color:white; font-family:'gameFont',sans-serif; font-size: 1.5rem;
      background-image:url('peach1.webp');background-size:6rem;background-repeat:no-repeat;background-position:0rem;
    }
    #helpDiv h2 {
      background-image:url('happy1.webp');background-size:contain;background-repeat: no-repeat;background-position:0px;
      padding:0 0 0 48px; color:#fff;
    }
    #title {position:absolute; z-index:2; top:0; left:0; width:100%;padding:0;text-align:center; font-size:3vmin; color:white; white-space:pre;}
    #controls {position:absolute; z-index:3; bottom:0; left:0; width:100%; display:none;}
    button {cursor:pointer;
            float:left;margin:0;padding:0;text-align:center; border-radius:8px; font-family:'gameFont',sans-serif;font-size: 4vmin;
            background-color:#666; color:white;
            background-repeat: no-repeat;}
    button:disabled {opacity:25%;}
    .btn1 { width:var(--btnsize); height:var(--btnsize); background-size:cover; 
            text-shadow: 2px 2px 3px black;
          } /* square button */
    .btn2 { width:calc(10vmin); height:var(--btnsize);margin:1px; padding:0; font-size: 2vmin;}
    .separator { height:16px; clear:left; }
    .indepth {font-size:1rem;color:#DDD;}
  </style>
</head>
<body id="body">
  <div id="splashScreen">
    <div style="text-align: center; vertical-align:center; margin:1rem 0rem; font-size:5rem;"> T O A D   B U R N </div>
    <div style="text-align: center; margin:2rem 0rem; font-size:2rem;"> By Yen Lee Loh and Isaac Hutchison </div>
    <div id="statusBar" style="text-align: center; font-size:0.5rem; white-space:pre;">Click or press any key to start!</div>
  </div>
  <div id="preloadContainer" style="display:none;">
<img id="imgQuestion" src="question.webp"></img>
<!-- <img id="imgMarioE" src="marioE.webp"></img> -->
<!-- <img id="imgMarioW" src="marioW.webp"></img> -->
<img id="imgMarioN" src="marioN.webp"></img>

<img id="imgMarioE" src="Mario - Walk2.gif"></img>
<img id="imgMarioE2" src="Mario - Walk3.gif"></img>
<img id="imgMarioE3" src="Mario - Walk1.gif"></img>
<img id="imgMarioW" src="marioW2.gif"></img>
<img id="imgMarioW2" src="marioW3.gif"></img>
<img id="imgMarioW3" src="marioW1.gif"></img>

<img id="imgMarioS" src="marioS1.gif"></img>



<img id="imgPeach1" src="peach1.webp"></img>
<img id="imgPeach2" src="peach2.webp"></img>
<img id="imgBowser" src="bowser.webp"></img>
<img id="imgGrass" src="grass.webp"></img>
<img id="imgDirt" src="dirt.webp"></img>
<img id="imgLava" src="lava.webp"></img>
<img id="imgLava2" src="lava2.webp"></img>
<img id="imgCrying1" src="crying1.webp"></img>
<img id="imgCrying2" src="crying2.webp"></img>
<img id="imgHappy1" src="happy1.webp"></img>
<img id="imgHappy2" src="happy2.webp"></img>
<img id="imgStarOn" src="staron.webp"></img>
<img id="imgStarOff" src="staroff.webp"></img>
<img id="imgSourceOff" src="sourceoff.webp"></img>
<img id="imgSourceOn" src="sourceon.webp"></img>
<audio id="audioBuzz"><source src="buzz.mp3"></audio>
<audio id="audioWin0"><source src="win1.mp3"></audio>
<audio id="audioWin1"><source src="win2.mp3"></audio>
<audio id="audioCoin"><source src="coin.mp3"></audio>
<audio id="audioTock"><source src="tock.mp3"></audio>
<audio id="audioLose"><source src="lose.mp3"></audio>
<audio id="audioOof"><source src="oof.mp3"></audio>
<audio id="audioOw"><source src="ow.mp3"></audio>
  </div>
  <div id="helpDivContainer">
    <div id="helpDiv"></div>
  </div>
  <div id="title"></div> 
  <canvas id="canvas">Your browser does not support the HTML5 canvas tag.</canvas>



  <script type="module">
    //=======================================================
    // IMAGE, AUDIO, AND STRING LOADERS
    //=======================================================
    function log(s) { statusBar.innerText += ' '+s+'\n' }
    class Sound {
      vol=1; buf=null; node=null; static ctx     

      constructor(filename) {
        if(!Sound.ctx) Sound.ctx = new (window.AudioContext||window.webkitAudioContext)()
        let ajax =new XMLHttpRequest()
        ajax.open("GET", filename, true); ajax.responseType="arraybuffer"
        ajax.onerror=()=>{debugger}
        ajax.onload=()=>{
          Sound.ctx.decodeAudioData(ajax.response, success=>{this.buf=success}, failure=>{debugger})
        }
        ajax.send()
      }
      play() {    
        if(!this.buf)return false
        let source=Sound.ctx.createBufferSource(); if(!source)return false
        source.buffer=this.buf
        if(!source.start) source.start=source.noteOn; if(!source.start)return false
        this.node=Sound.ctx.createGain()
        this.node.gain.value=this.vol;source.connect(this.node);this.node.connect(Sound.ctx.destination)
        source.start(0); return true
      }
      stop(sound) {
        if(this.node) this.node.gain.value=0
      }
    }
    

    function loadImage(url) { 
      // log ('Requesting ' + url)
      return new Promise((resolve,reject) => { 
        let image = new Image()
        image.onload  = ()=>{log('Loaded '+url);resolve(image)}
        image.onerror = ()=>{log('Failed to load '+url);reject()      }
        image.src     = url
      })
    }
    // function loadAudio(url) {
    //   // log ('Requesting ' + url)
    //   return new Promise((resolve,reject) => { 
    //     let audio = new Audio(url)
    //     audio.oncanplaythrough = ()=>{log('Loaded '+url);resolve(audio)}
    //     audio.onerror          = ()=>{log('Failed to load '+url);reject()}
    //   })
    // }
    function loadString(url) {
      // log ('Requesting ' + url)
      return fetch(url).then(r=>r.text()) 
    }
    //=================================================
    // GRAPHICS
    //=================================================
    // function rgb(r,g,b) {return ["rgb(",r,",",g,",",b,")"].join("");}
    // function xyBoard(x,y) {return[Math.floor(x/cellsize),Math.floor(y/cellsize)]}
    // function xyScreen(x,y) {return[x*cellsize,y*cellsize]} // top left corner
    const clamp=(x,a,b) => Math.min(Math.max(x,a),b)
    class Animation {
      constructor(frames)       {this.frames = frames } // list of images
      draw(x, y, iFrame)        {ctx.drawImage(this.frames[iFrame], x, y)  }
      draw(x, y, w, h, iFrame)  {ctx.drawImage(this.frames[iFrame], x, y, w, h)  }
    }







    
    function setScaling() {
      winWid=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth
      winHei=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight
      let availWidth =clamp(winWid, 300, 1600) // set canvas width according to window width; warning: btnSize=48
      let availHeight=clamp(winHei*(1-.08), 300, 1200) // may reduce this
      cellsize=Math.min(Math.floor(availWidth/X),Math.floor((availHeight)/Y)) // for graphics
      canvas.width=X*cellsize
      canvas.height=Y*cellsize
      canvas.style.left = Math.floor((winWid-canvas.width)/2) + "px"
      title.style.left  = Math.floor((winWid-canvas.width)/2) + "px"
      title.style.width = canvas.width + "px"
    }
    function render() {
      const h=cellsize // alias for convenience
      //======== DRAW BACKGROUND AND GAME AREA
      ctx.clearRect(0, 0, canvas.width, canvas.height)
      ctx.fillStyle='#000';   ctx.fillRect(0,0, X*h, Y*h)
      //======== DRAW
      for (let y=0; y<Y; ++y) for (let x=0; x<X; ++x) {
         ctx.drawImage(imgGrass, x*h, y*h, h, h)
      }
      //======== DRAW MARIO
      const maxWalkSteps = 7
      if (xCurPrev!=xCursor||yCurPrev!=yCursor) nWalk = Math.floor(((Date.now() - tWalk))/17) 
      xMario = xCurPrev + (xCursor-xCurPrev)*nWalk/maxWalkSteps
      yMario = yCurPrev + (yCursor-yCurPrev)*nWalk/maxWalkSteps
      if (nWalk==maxWalkSteps) {  xCurPrev=xCursor; yCurPrev=yCursor; nWalk=0} // go back to standing still

      let asp=imgMarioE.height/imgMarioE.width;
      let xcen=(xMario+.5)*h,ycen=(yMario+.5)*h
      let sy=h*1.1, sx=sy/asp
      switch (marioOrientation) {// should draw frame of animation, and cycle through frames 
        case 0: animMarioE.draw(xcen-sx/2, ycen-sy/2, sx,sy, nWalk%3); break
        case 1: animMarioW.draw(xcen-sx/2, ycen-sy/2, sx,sy, nWalk%3); break
        case 2: ctx.drawImage(imgMarioN, xcen-sx/2, ycen-sy/2, sx, sy); break // to do: anim
        case 3: ctx.drawImage(imgMarioS, xcen-sx/2, ycen-sy/2, sx, sy); break
      }
    }
    
    let timeOfLastFrame=0
    let timeStepInMilliseconds = 1/60.
    
    function animate(timeCurrent) {
      requestAnimationFrame(animate)
      render() 
      
      if (isKeyDown('s')) walkW()//      if (isKeyDown('ArrowLeft')) walkW()
      if (isKeyDown('f')) walkE()
      if (isKeyDown('e')) walkN()
      if (isKeyDown('d')) walkS()

      let elapsed = Date.now() - timeOfLastFrame
      if (elapsed <= timeStepInMilliseconds) return
      timeOfLastFrame = Date.now()
    
      //evolve()
    }


    let xMario,yMario,nWalk=0,tWalk=0
    function tryWalk(xnew,ynew) {
      if (xMario!=xCursor || yMario!=yCursor) return // Mario is still walking; do nothing
      if (xnew<0||xnew>=X||ynew<0||ynew>=Y) {soundBuzz.play(); return 0} // Illegal move
      soundTock.play();  // Initiate the walk
      xCursor=xnew; yCursor=ynew; tWalk=Date.now()
      return 1
    }
    function walkW() {marioOrientation=1; tryWalk(xCursor-1,yCursor)}
    function walkE() {marioOrientation=0; tryWalk(xCursor+1,yCursor)}
    function walkN() {marioOrientation=2; tryWalk(xCursor,yCursor-1)}
    function walkS() {marioOrientation=3; tryWalk(xCursor,yCursor+1)}

    function keydown(e) {
      // if (helpDiv.style.display=="block") {helpDiv.style.display="none"; return}
      if (e.ctrlKey||e.altKey) return // don't trap browser shortcuts involving Ctrl or Alt
      let processed=true
      switch (e.key) {
        // case '[': setLevel(level-1); break
        // case ']': setLevel(level+1); break
        // case 'C': enterCheatMode(); break
        // case 'R': await resetGame(); break    // reset level
        default: processed=false
      }
      //if (e.shiftKey==true) ground[xCursor+X*yCursor] = 3 // add cold dormant
      if (processed) {e.preventDefault(); e.stopPropagation(); }
    }


    function launchGame() {
      X=20,Y=6
      xCursor=2,yCursor=2
      xCurPrev=xCursor,yCurPrev=yCursor
      setScaling()

      splashScreen.style.display = 'none' // Hide splash screen
      document.body.removeEventListener('keydown', launchGame, false)
      window.addEventListener('resize', setScaling)
      document.body.addEventListener('dblclick', e=>e.preventDefault())
      document.body.onkeydown = keydown
      requestAnimationFrame(animate)
    }

    //===============================================
    // GLOBAL VARIABLES
    //===============================================
    const ctx=canvas.getContext('2d')
    let winWid,winHei,cellsize,X,Y
    let xCursor,yCursor,xCurPrev,yCurPrev // cursor position (actually player)
    let marioOrientation=3;
    //===============================================
    // MAIN MODULE CODE
    //===============================================
    "use strict";
    const isKeyDown = (() => {
      const state = {};
      window.addEventListener('keyup', (e) => state[e.key] = false);
      window.addEventListener('keydown', (e) => state[e.key] = true);
      return (key) => state.hasOwnProperty(key) && state[key] || false;
    })();

    let animPeach = new Animation([imgPeach1,imgPeach2])
    let animLava  = new Animation([imgLava,imgLava2])
    let animCrying= new Animation([imgCrying1,imgCrying2])
    let animHappy = new Animation([imgHappy1,imgHappy2])
    let animMarioE= new Animation([imgMarioE,imgMarioE2,imgMarioE3])
    let animMarioW= new Animation([imgMarioW,imgMarioW2,imgMarioW3])
    let soundTock = new Sound('tock.mp3')
    let soundBuzz = new Sound('buzz.mp3')
    let soundWin1 = new Sound('win1.mp3')
    let soundWin2 = new Sound('win2.mp3')
    let levelMaps = loadString('toadburnmaps.txt') // clear browser cache if this file is edited
    
    splashScreen.addEventListener('click', launchGame)
    document.body.addEventListener('keydown', launchGame, false)
    
  </script>
</body>
</html> 