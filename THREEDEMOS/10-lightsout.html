<!DOCTYPE html>
<html lang="en">

<head>
  <title>Marble game ....Yen Lee Loh </title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <style>
    #info {
      position: absolute;
      top: 36px;
      width: 100%;
      text-align: center;
      color: white;
      z-index: 100;
      display: block;
      font-family: monospace;
      font-size: 24px;
    }
  </style>

</head>

<body>

  <div id="info">Turn all the lights out!</div>

  <script type="module">
    //================================
    // SOUND 
    //================================
    function sound(src) {
      this.sound = document.createElement("audio");
      this.sound.src = src;
      this.sound.setAttribute("preload", "auto");
      this.sound.setAttribute("controls", "none");
      this.sound.style.display = "none";
      document.body.appendChild(this.sound);
      this.play = function () { this.sound.play(); }
      this.stop = function () { this.sound.pause(); }
    }

    //================================
    // GAME DATA
    //================================

    //================================
    // GRAPHICS VARIABLES AND UTILITIES
    //================================

    //-------- Load THREE.js from CDN
    //import * as THREE from 'https://cdn.skypack.dev/three@0.129.0';
    //import { FlyControls } from 'https://cdn.skypack.dev/three@0.129.0/examples/jsm/controls/FlyControls.js';
    //-------- Load THREE.js from current directory on a HTTP server (python3 -m http.server 8000)
    import * as THREE from './three.module.js';
    import { FlyControls } from './FlyControls.js';

    let camera, scene, renderer, controls;
    let material0, material1, material2;
    let msg;
    let meshBall;
    //const clock = new THREE.Clock();
    const mouse = new THREE.Vector2();
    const raycaster = new THREE.Raycaster();
    var switches; // array of (graphics) objects // could have separate array of lights
    var xmax, ymax, imax;
    var gamemat; // effect of each switch
    var xi, yi, si, li; // positions, input (switch) states, and output (light) states

    function setMessage(str) { info.innerHTML = str; }

    //================================
    // PRELOAD SOUNDS AND TEXTURES 
    //================================
    const mySound = new sound("Tink.mp3");

    function toggleSwitch(i) {
      for (let i2 = 0; i2 < imax; ++i2) {
        if (gamemat[i + imax * i2] == 1) {
          toggleLight(i2);
        }
      }
    }


    function toggleLight(i) {
      if (li[i] == 0) {
        li[i] = 1;
        switches[i].material = material2;
      }
      else {
        li[i] = 0;
        switches[i].material = material1;
      }
    }

    function connect(x, y, x2, y2) {
      if (x2 < 0 || x2 >= xmax || y2 < 0 || y2 >= ymax) return;
      gamemat[(x + xmax * y) + imax * (x2 + xmax * y2)] = 1;
    }

    function init() {
      //-------- GAME PARAMETERS
      xmax = 5;
      ymax = 5;
      imax = xmax * ymax;
      xi = new Array(imax).fill(0);
      yi = new Array(imax).fill(0);
      si = new Array(imax).fill(0);
      li = new Array(imax).fill(0);
      gamemat = new Array(imax * imax).fill(0);
      for (let x = 0; x < xmax; ++x) {
        for (let y = 0; y < ymax; ++y) {
          connect(x, y, x, y);
          connect(x, y, x + 1, y);
          connect(x, y, x - 1, y);
          connect(x, y, x, y + 1);
          connect(x, y, x, y - 1);
        }
      }
      //for (let i=0; i<imax; ++i) {
      for (let x = 0; x < xmax; ++x) {
        for (let y = 0; y < ymax; ++y) {
          xi[x + xmax * y] = x;
          yi[x + xmax * y] = y;
          si[x + xmax * y] = 0;
          li[x + xmax * y] = 0;
        }
      }

      let xCenter = (xmax - 1) / 2;
      let yCenter = (ymax - 1) / 2;
      let camDist = xmax * 1.5;
      //-------- SCENE, CAMERA, LIGHTS
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x111111);
      camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 1000);

      //camera.position.set(0, 0, 100); camera.lookAt(0, 0, 0); // top view
      camera.position.set(xCenter, -.4 * camDist, .6 * camDist); camera.lookAt(xCenter, yCenter, 0); // side view
      // camera = new THREE.OrthographicCamera(
      //   -5, 5,
      //   5*window.innerHeight/window.innerWidth, -5*window.innerHeight/window.innerWidth,
      //   1, 1000);
      // camera.position.set(0, 0, 100);

      scene.add(new THREE.AmbientLight(0x333333));
      {
        const light = new THREE.DirectionalLight(0xCCCCCC, 1.0);
        light.position.set(0, 0, 0);
        light.target.position.set(1, 1, -1);
        light.castShadow = true;
        light.shadow.camera.near = .1;
        light.shadow.camera.far = 1000;
        light.shadow.mapSize.width = 1024;
        light.shadow.mapSize.height = 1024;
        scene.add(light); scene.add(light.target);
      }
      //-------- GROUND (PLAYING FIELD)
      switches = new Array(imax);
      const geometry = new THREE.CylinderGeometry(.45, .45, .3, 24).rotateX(Math.PI / 2); // align along z
      material0 = new THREE.MeshPhongMaterial();
      material1 = new THREE.MeshPhongMaterial();
      material2 = new THREE.MeshPhongMaterial();
      material0.color.setHex(0x669999);
      material1.color.setHex(0x999999);
      material2.color.setHex(0x999999); material2.emissive.setHex(0x666633);

      const plate = new THREE.Mesh(new THREE.BoxGeometry(xmax + 1, ymax + 1, 1), material0);
      plate.position.set(xmax / 2 - .5, ymax / 2 - .5, -1 + .4);
      plate.receiveShadow = true;
      scene.add(plate);

      for (let i = 0; i < imax; ++i) {
        const mesh = new THREE.Mesh(geometry, material1);
        mesh.position.x = xi[i];
        mesh.position.y = yi[i];
        mesh.position.z = 0;
        mesh.name = i.toString();
        switches[i] = mesh;
        mesh.castShadow = true;
        scene.add(mesh);
      }


      //-------- Scramble to get initial state  (move to NEWGAME routine)
      //state = new Array(imax);
      //solution = new Array(imax);
      //for (let i = 0; i < imax; ++i) solution[i] = 0; 
      //for (let i = 0; i < imax; ++i) state[i] = 0;
      for (let i = 0; i < imax; ++i) {
        if (Math.random() > 0.5) {
          toggleSwitch(i);
        }
        //solution[x + xmax * y] = 1;
      }

      

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFShadowMap;

      controls = new FlyControls(camera, renderer.domElement);
      controls.movementSpeed = 10;
      controls.domElement = renderer.domElement;
      controls.rollSpeed = Math.PI / 24;
      controls.autoForward = false;
      controls.dragToLook = true;

      document.body.insertBefore(renderer.domElement, document.body.firstChild);
      window.addEventListener('resize', onResize);
      window.addEventListener('mousedown', onMouseDown);
      window.addEventListener('mouseup', onMouseUp);
      renderer.render(scene, camera);
    }

    function onResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.render(scene, camera);
    }



    var iSelected;
    var objSelected;
    function onMouseDown(event) {
      event.preventDefault();
      mouse.x = (event.offsetX / window.innerWidth) * 2 - 1;
      mouse.y = - (event.offsetY / window.innerHeight) * 2 + 1;
      raycaster.setFromCamera(mouse, camera);
      const intersections = raycaster.intersectObjects(switches, true);
      if (intersections.length > 0) {
        const object = intersections[0].object; // topmost object under click
        objSelected = object;
        objSelected.position.z = -.1;
        //mySound.play();
        let i = parseInt(objSelected.name);
        toggleSwitch(i);
      }
      renderer.render(scene, camera);
    }
    function onMouseUp(event) {
      event.preventDefault();
      objSelected.position.z = 0;
      renderer.render(scene, camera);
    }

    //================================
    // START THE GAME!
    //================================
    init();

  </script>

  <div>
    <h1>
      TBD...
    </h1>
    <p>
      sdff
    </p>
  </div>


</body>

</html>